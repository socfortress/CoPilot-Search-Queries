name: Windows Process Creating LNK File in Suspicious Location
id: windows-process-creating-lnk-suspicious-location-001
version: 1
schema_version: "1.0"
date: "2026-02-16"
author: SOCFortress LLC
status: production
type: TTP

description: >
  Detects .lnk file creation in suspicious locations such as user profile 
  directories and Temp folders via Sysmon EventID 11 (File Create). This is a 
  common spear phishing technique used by Qakbot, IcedID, Amadey, and Gozi 
  to establish persistence or execute malicious payloads.

data_source:
  - Sysmon EventID 11

search:
  index_pattern: "${INDEX_PATTERN}"
  size: 100
  sort:
    - timestamp: desc
  query:
    bool:
      must:
        - term:
            agent_name: "${AGENT_NAME}"
        - term:
            agent_labels_customer: "${CUSTOMER_CODE}"
        - term:
            data_win_system_eventID: "11"
        - wildcard:
            data_win_eventdata_targetFilename: "*.lnk"
        - bool:
            should:
              - wildcard:
                  data_win_eventdata_targetFilename: "C:\\Users\\*"
              - wildcard:
                  data_win_eventdata_targetFilename: "*\\Temp\\*"
            minimum_should_match: 1
        - range:
            timestamp:
              gte: "${START_TIME}"
              lte: "${END_TIME}"
  _source:
    - timestamp
    - agent_name
    - data_win_system_eventID
    - data_win_eventdata_targetFilename
    - data_win_eventdata_image
    - data_win_eventdata_user

parameters:
  AGENT_NAME:
    description: "Target agent/host name"
    type: string
    required: true
    example: "DESKTOP-AM0HLGE"
  CUSTOMER_CODE:
    description: "Customer label for filtering"
    type: string
    required: true
    example: "lab"
  START_TIME:
    description: "Query start time (ISO 8601 or relative)"
    type: datetime
    required: false
    default: "now-24h"
    example: "2026-02-16 00:00:00.000"
  END_TIME:
    description: "Query end time (ISO 8601 or relative)"
    type: datetime
    required: false
    default: "now"
    example: "2026-02-16 23:59:59.999"

how_to_implement: >
  This detection requires Wazuh agents deployed on Windows endpoints with Sysmon 
  installed and configured to log file creation events (EventID 11). Ensure Sysmon 
  configuration includes monitoring of .lnk file creation.

known_false_positives: >
  Some legitimate applications may create .lnk files in user directories. Filter 
  based on the creating process image. Browser downloads and application installers 
  are common sources of benign .lnk files.

references:
  - https://attack.mitre.org/techniques/T1566/002/
  - https://www.trendmicro.com/en_us/research/17/e/rising-trend-attackers-using-lnk-files-download-malware.html

response:
  message: >
    Suspicious .lnk file created on $agent_name$. 
    File: $data_win_eventdata_targetFilename$. 
    Process: $data_win_eventdata_image$. 
    User: $data_win_eventdata_user$. MITRE ATT&CK: T1566.002
  risk_score: 50
  severity: medium
  risk_objects:
    - field: agent_name
      type: system
      score: 50
  threat_objects: []

tags:
  analytic_story:
    - Spearphishing Attachments
    - Qakbot
    - IcedID
    - Amadey
    - Gozi Malware
    - Compromised Windows Host
  asset_type: Endpoint
  mitre_attack_id:
    - T1566.002
  product:
    - Wazuh
  security_domain: endpoint
