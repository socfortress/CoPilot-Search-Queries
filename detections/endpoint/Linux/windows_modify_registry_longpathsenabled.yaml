name: Windows Modify Registry LongPathsEnabled
id: windows-modify-registry-longpathsenabled-001
version: 1
schema_version: "1.0"
date: "2026-02-27"
author: SOCFortress LLC
status: production
type: Anomaly

description: >
  Detects modification of LongPathsEnabled registry value to 1, allowing file 
  paths longer than 260 characters. BlackByte ransomware exploits this setting 
  to bypass file path limitations, enabling execution of payloads with deeply 
  nested or long directory paths as an evasion technique.

data_source:
  - Sysmon EventID 13

search:
  index_pattern: "${INDEX_PATTERN}"
  size: 100
  sort:
    - timestamp: desc
  query:
    bool:
      must:
        - term:
            agent_name: "${AGENT_NAME}"
        - term:
            agent_labels_customer: "${CUSTOMER_CODE}"
        - term:
            data_win_system_eventID: "13"
        - wildcard:
            data_win_eventdata_targetObject: "*\\Control\\FileSystem\\LongPathsEnabled"
        - term:
            data_win_eventdata_details: "DWORD (0x00000001)"
        - range:
            timestamp:
              gte: "${START_TIME}"
              lte: "${END_TIME}"
  _source:
    - timestamp
    - agent_name
    - data_win_system_eventID
    - data_win_eventdata_targetObject
    - data_win_eventdata_details
    - data_win_eventdata_image
    - data_win_eventdata_user

parameters:
  AGENT_NAME:
    description: "Target agent/host name"
    type: string
    required: true
    example: "DESKTOP-AM0HLGE"
  CUSTOMER_CODE:
    description: "Customer label for filtering"
    type: string
    required: true
    example: "lab"
  START_TIME:
    description: "Query start time (ISO 8601 or relative)"
    type: datetime
    required: false
    default: "now-24h"
    example: "2026-02-27 00:00:00.000"
  END_TIME:
    description: "Query end time (ISO 8601 or relative)"
    type: datetime
    required: false
    default: "now"
    example: "2026-02-27 23:59:59.999"

how_to_implement: >
  Requires Sysmon EventID 13 (Registry Value Set) configured to monitor 
  FileSystem registry paths. This path is typically included in default 
  Sysmon configurations under CurrentControlSet\Control.

known_false_positives: >
  Administrators may enable long paths for development or application 
  compatibility. Investigate process and user context.

references:
  - https://www.microsoft.com/en-us/security/blog/2023/07/06/the-five-day-job-a-blackbyte-ransomware-intrusion-case-study/
  - https://attack.mitre.org/techniques/T1112/

response:
  message: >
    Long paths enabled on $agent_name$. 
    Registry: $data_win_eventdata_targetObject$. 
    Process: $data_win_eventdata_image$. 
    User: $data_win_eventdata_user$. 
    Possible BlackByte ransomware. MITRE ATT&CK: T1112
  risk_score: 16
  severity: low
  risk_objects:
    - field: agent_name
      type: system
      score: 16
  threat_objects: []

tags:
  analytic_story:
    - BlackByte Ransomware
    - Compromised Windows Host
  asset_type: Endpoint
  mitre_attack_id:
    - T1112
  custom_tags:
    - longpaths
    - filesystem
    - blackbyte
    - defense_evasion
  product:
    - Wazuh
  security_domain: endpoint
