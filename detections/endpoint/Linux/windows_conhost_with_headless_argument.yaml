name: Windows ConHost with Headless Argument
id: windows-conhost-headless-argument-001
version: 1
schema_version: "1.0"
date: "2026-02-23"
author: SOCFortress LLC
status: production
type: TTP

description: >
  Detects conhost.exe invoked with the undocumented --headless parameter, 
  enabling stealthy command execution without a visible console window. This 
  technique is used in spearphishing attacks and post-exploitation to execute 
  commands invisibly.

data_source:
  - Sysmon EventID 1

search:
  index_pattern: "${INDEX_PATTERN}"
  size: 100
  sort:
    - timestamp: desc
  query:
    bool:
      must:
        - term:
            agent_name: "${AGENT_NAME}"
        - term:
            agent_labels_customer: "${CUSTOMER_CODE}"
        - term:
            data_win_system_eventID: "1"
        - wildcard:
            data_win_eventdata_commandLine: "*--headless*"
        - range:
            timestamp:
              gte: "${START_TIME}"
              lte: "${END_TIME}"
  _source:
    - timestamp
    - agent_name
    - data_win_system_eventID
    - data_win_eventdata_image
    - data_win_eventdata_commandLine
    - data_win_eventdata_parentImage
    - data_win_eventdata_user

parameters:
  AGENT_NAME:
    description: "Target agent/host name"
    type: string
    required: true
    example: "DESKTOP-AM0HLGE"
  CUSTOMER_CODE:
    description: "Customer label for filtering"
    type: string
    required: true
    example: "lab"
  START_TIME:
    description: "Query start time (ISO 8601 or relative)"
    type: datetime
    required: false
    default: "now-24h"
    example: "2026-02-23 00:00:00.000"
  END_TIME:
    description: "Query end time (ISO 8601 or relative)"
    type: datetime
    required: false
    default: "now"
    example: "2026-02-23 23:59:59.999"

how_to_implement: >
  This detection requires Wazuh agents deployed on Windows endpoints with Sysmon 
  installed and configured to log process creation events (EventID 1) including 
  conhost.exe. Verify conhost.exe is not excluded in Sysmon config and that 
  Wazuh forwards these events.

known_false_positives: >
  Some legitimate applications may use the --headless parameter. Filter by user 
  or endpoint as needed.

references:
  - https://attack.mitre.org/techniques/T1564/003/
  - https://x.com/embee_research/status/1559410767564181504

response:
  message: >
    ConHost with --headless argument on $agent_name$. 
    Command: $data_win_eventdata_commandLine$. 
    Parent: $data_win_eventdata_parentImage$. 
    User: $data_win_eventdata_user$. MITRE ATT&CK: T1564.003
  risk_score: 72
  severity: high
  risk_objects:
    - field: agent_name
      type: system
      score: 72
  threat_objects: []

tags:
  analytic_story:
    - Spearphishing Attachments
    - Compromised Windows Host
  asset_type: Endpoint
  mitre_attack_id:
    - T1564.003
    - T1564.006
  custom_tags:
    - conhost
    - headless
    - stealth_execution
    - defense_evasion
  product:
    - Wazuh
  security_domain: endpoint
